# shellcheck shell=bash
# shellcheck disable=SC2312

RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
BOLD=$(tput bold)
RESET=$(tput sgr0)

# Print UTF-8 char?
# To define fallback chars for terms that don't support Unicode
__ps1_utf8(){
  case "${TERM}" in
    xterm*)
      echo "${1}";;
    *)
      echo "${2}";;
  esac
}

# The opening and closing characters for info in the prompt
PS1_Op="$(__ps1_utf8 âŸª '[')"
PS1_Cl="$(__ps1_utf8 âŸ« ']')"
# Other options, presented with the box drawing character,
# to see which look best with your particular terminal font:
# â•â´âµâ• â•â¨â©â• â•âªâ«â• â•â¬â­â• â•â®â¯â• â•â°â±â• â•â²â³â• â•â´âµâ• â•âŸ¦âŸ§â• â•âŸ¨âŸ©â• â•âŸªâŸ«â• â•âŸ¬âŸ­â•
# â•âŸ®âŸ¯â• â•â¦ƒâ¦„â• â•â¦…â¦†â• â•â¦‡â¦ˆâ• â•â¦‰â¦Šâ• â•â¦‹â¦Œâ• â•â¦â¦â• â•â¦â¦â• â•â¦‘â¦’â• â•â¦“â¦”â• â•â¦•â¦–â• â•â¦—â¦˜â•
# â•â¨   â•â§â§â• â•â§‘ â§’â• â•â§“â• â•â§” â§•â• â•â¨â• â•â¨­ â¨®â• â•â¨´ â¨µâ• â•â©¤ â©¥â• â•â©¹ â©ºâ• â•â©½ â©¾â•
# â•â©¿âª€â• â•âªâª‚â• â•âªƒâª„â• â•âª‹âªŒâ• â•âª•âª–â• â•âª—âª˜â• â•âª™âªšâ• â•âª›âªœâ• â•âª¡âª¢â• â•âª¥ â•âª¦ âª§â• â•âª¨âª©â•
# â•âªªâª«â• â•âª¬âª­â• â•âª¯âª°â• â•âª³âª´â• â•âª»âª¼â• â•âª½âª¾â• â•â«‡â«ˆâ• â•â«â«â• â•â«â«â• â•â«‘â«’â• â•â«—â•  â•â«˜â•
# â«â• â•â«£ â«¤ â«¥ â«¦â• â•â«¬ â«­â• â•â«· â«¸â• â•â«¹ â«ºâ• â•â«» â«»â• â•â­† â­…â• â•â®† â®„â• â•â®Š â®ˆâ• â•â® â®Œâ•
# â•â®‘ â®â•  â•â®˜ â®šâ• â•â®œ â®â• â•â®¡ â® â• â•â®£ â®¢â• â•â®© â®¨â• â•â®« â®ªâ• â•â®µ â®¶â• â•â®· â®´â• â•â¯° â¯°â•
# â•â¯´ â¯´â• â•â¯µ â¯µâ•  â•â¯º â¯ºâ• â•â¯¼ â¯¼â• â•â¸ â¸â• â•â¸¦ â¸§â• â•â¸¨ â¸©â• â•â¸¬ â¸¬â• 
# â•ã€ˆã€‰â• â•ã€Šã€‹â• â•ã€Œã€â• â•ã€ã€â• â•ã€ã€‘â• â•ã€”ã€•â• â•ã€–ã€—â• â•ã€˜ã€™â• â•ã€šã€›â•

# Disable Python virtualenv modifications to the prompt
# That's taken care of here instead
export VIRTUAL_ENV_DISABLE_PROMPT="yes"
__ps1_getVirtualenv(){
  if [[ -v VIRTUAL_ENV ]]; then
    echo -n "${PS1_Op}$(basename ${VIRTUAL_ENV})${PS1_Cl}"
  fi
}

# Print UTF-8 time char?
__ps1_utf8time(){
  case "${TERM}" in
    xterm*)
      case "${1}:${2}" in
        01:[0-2][0-9]) echo "ğŸ•";; 01:[3-5][0-9]) echo "ğŸ•œ";;
        02:[0-2][0-9]) echo "ğŸ•‘";; 02:[3-5][0-9]) echo "ğŸ•";;
        03:[0-2][0-9]) echo "ğŸ•’";; 03:[3-5][0-9]) echo "ğŸ•";;
        04:[0-2][0-9]) echo "ğŸ•“";; 04:[3-5][0-9]) echo "ğŸ•Ÿ";;
        05:[0-2][0-9]) echo "ğŸ•”";; 05:[3-5][0-9]) echo "ğŸ• ";;
        06:[0-2][0-9]) echo "ğŸ••";; 06:[3-5][0-9]) echo "ğŸ•¡";;
        07:[0-2][0-9]) echo "ğŸ•–";; 07:[3-5][0-9]) echo "ğŸ•¢";;
        08:[0-2][0-9]) echo "ğŸ•—";; 08:[3-5][0-9]) echo "ğŸ•£";;
        09:[0-2][0-9]) echo "ğŸ•˜";; 09:[3-5][0-9]) echo "ğŸ•¤";;
        10:[0-2][0-9]) echo "ğŸ•™";; 10:[3-5][0-9]) echo "ğŸ•¥";;
        11:[0-2][0-9]) echo "ğŸ•š";; 11:[3-5][0-9]) echo "ğŸ•¦";;
        12:[0-2][0-9]) echo "ğŸ•›";; 12:[3-5][0-9]) echo "ğŸ•§";;
        *) ;;
      esac
    ;;
    *) ;;
  esac
}

__ps1_color_wrap_non_printing(){
  local ESC; ESC=$(echo -e '\033')
  local SOH; SOH=$(echo -e '\001')
  local STX; STX=$(echo -e '\002')
  local REGEX; REGEX=${ESC}'\[[[:digit:];]*m'
  local REPLACE; REPLACE=${SOH}'&'${STX}
  sed "s/${REGEX}/${REPLACE}/g"
}

# Get tty
__ps1_tty(){ tty | cut -c 6-; }

# Uptime
__ps1_uptime(){
  local PS1_upsecs; PS1_upsecs=$(awk '{print $1}' /proc/uptime | awk -F . '{print $1}')
  date -ud @"${PS1_upsecs}" +"$((PS1_upsecs/3600/24))d %H:%M"
}

# Dir stats
__ps1_dirSize(){ sed -n 1p <<< "${PS1_dirList}" | awk '{print $2}'; }
__ps1_files(){ \grep "^-" <<< "${PS1_dirList}" | awk '{print $9}' | \grep -cv "^\."; }
__ps1_hiddenFiles(){ \grep "^-" <<< "${PS1_dirList}" | awk '{print $9}' | \grep -c "^\."; }
__ps1_execs(){ \grep -c "^-..x" <<< "${PS1_dirList}"; }
__ps1_dirs(){ \grep "^d" <<< "${PS1_dirList}" | awk '{print $9}' | \grep -cv "^\."; }
__ps1_hiddenDirs(){ \grep "^d" <<< "${PS1_dirList}" | awk '{print $9}' | \grep -c "^\."; }
__ps1_links(){ \grep -c "^l" <<< "${PS1_dirList}"; }
__ps1_spec(){ \grep -c "^[bcps]" <<< "${PS1_dirList}"; }

# Calculate padding
__pad(){
  local len pad

  if [[ "${1}" = 1_L1 ]]; then
    len="$(wc -m <<< "${PS1_L1@P}")"
  else
    len="$(wc -m <<< "${PS1_L2@P}")"
  fi
  if [[ "${TERM}" = xterm* ]]; then
    if [[ "${1}" = 1_L1 ]]; then
      pad=$((COLUMNS-len-11))
    else
      pad=$((COLUMNS-len-8))
    fi
  else {
    if [[ "${1}" = 1_L1 ]]; then
      pad=$((COLUMNS-len-14))
    else
      pad=$((COLUMNS-len))
    fi
  }
  fi

  printf %"${pad}"s | sed 's/ /â•/g'
}

# Set the title of a terminal emulator to include the command being executed
__ps1_preCommand(){
  case "${TERM}" in
    xterm*|rxvt*)
      local pwd='~'
      [[ "${PWD}" != "${HOME}" ]] && pwd=${PWD/#${HOME}\//\~\/}
      pwd="${pwd//[[:cntrl:]]}"
      echo -ne "\033]0;$(__ps1_getVirtualenv) ${USER}@${HOSTNAME%%.*}($(__ps1_tty))($(jobs -r | wc -l)R/$(jobs -s | wc -l)S):${pwd} (${BASH_COMMAND})\007"
    ;;
    *) ;;
  esac
}
trap "__ps1_preCommand" DEBUG

# Color, dirList, and lolcat options based on the terminal
case "${TERM}" in
  xterm*) PS1_color=yes; PS1_getDirList=yes; PS1_lc_opts=( -v 0.1 -h 0.1 -b -f );;
   linux) PS1_color=yes; PS1_getDirList=yes; PS1_lc_opts=( -x -f );;
       *) ;;
esac

__prompt_command(){
  # Save last exit code
  local PS1_exit=$?

  local PS1_dirList PS1_L0 PS1_L1 PS1_L2 PS1_L3

  # Get dir listing, if we want it
  if [[ -n "${PS1_getDirList}" ]]
    then PS1_dirList=$(\ls -Al --si)
  fi

  # PS1 Line 1
  # Exit code of previous command
  PS1_L1=" â•šâ•${PS1_Op}${PS1_exit}${PS1_Cl}"
  # Name of the lion using this term
  PS1_L1+="â•â•${PS1_Op}$(__ps1_utf8 ğŸ¦ 'U:')\u${PS1_Cl}"
  # The TTY of this term
  PS1_L1+="â•â•${PS1_Op}$(__ps1_utf8 ğŸ“º 'T:')$(__ps1_tty)${PS1_Cl}"
  # The host of this term
  PS1_L1+="â•â•${PS1_Op}$(__ps1_utf8 ğŸ’» 'H:')\h${PS1_Cl}"
  # The uptime of this host
  PS1_L1+="â•â•${PS1_Op}$(__ps1_utf8 âš¡ 'Up:')$(__ps1_uptime)${PS1_Cl}"
  # Line padding and eternal flame
  PS1_L1+="$(__pad 1_L1)â•â•¡$(__ps1_utf8 ğŸ”¥ 'on I burn')â•â•â•â•—\n"
  # PS1 Line 2
  # The length of our command history, global and for this term
  PS1_L2="â•”â•${PS1_Op}\!:\#${PS1_Cl}"
  # Background jobs, running and sleeping
  PS1_L2+="â•â•${PS1_Op}$(__ps1_utf8 ğŸƒ 'R:')$(jobs -r | wc -l)/$(__ps1_utf8 ğŸ’¤ 'S:')$(jobs -s | wc -l)${PS1_Cl}"
  # Current Working Directory stat's...
  PS1_L2+="â•â•${PS1_Op}$(__ps1_utf8 ğŸ“‚ 'cwd:')\W($(__ps1_dirSize)B"
  # ...â„– files, normal and hidden...
  PS1_L2+=" $(__ps1_utf8 ğŸ“„ -)$(__ps1_files).$(__ps1_hiddenFiles)"
  # ...â„– executables...
  PS1_L2+=" $(__ps1_utf8 ğŸ’¾ x)$(__ps1_execs)"
  # ...â„– directories, normal and hidden...
  PS1_L2+=" $(__ps1_utf8 ğŸ“ d)$(__ps1_dirs).$(__ps1_hiddenDirs)"
  # ...â„– links...
  PS1_L2+=" $(__ps1_utf8 ğŸ”— l)$(__ps1_links)"
  # ...â„– special files
  PS1_L2+=" $(__ps1_utf8 ğŸ“  s)$(__ps1_spec))${PS1_Cl}"
  # Line padding
  PS1_L2+="$(__pad 1_L2)â•\n"
  # PS1 Line 3
  # If we're in a python virtual environment, print its name
  PS1_L3="â•šâ•¦$(__ps1_getVirtualenv)â•$(__ps1_utf8 â•¾ '>')$(__ps1_utf8 ğŸ’² '$') "

  # shellcheck disable=SC2016
  case "${PS1_color}" in
    yes) if [[ "${TERM}" == xterm* ]]
         then {
              PS0='$(lolcat-c '${PS1_lc_opts[*]}' <<< "â•¾â•¨â”€â”€â”€â”€â”¤Program running  $(__ps1_utf8 ğŸ—“ï¸) \d  $(__ps1_utf8time "$(date +"%I")" "$(date +"%M")")\D{}â”œ$(printf %$((COLUMNS-54))s | sed "s/ /â”€/g")â•®")'
           PS1_L0='$(lolcat-c '${PS1_lc_opts[*]}' <<< "â•¾â•¥â”€â”€â”€â”€â”¤Program finished $(__ps1_utf8 ğŸ—“ï¸) \d  $(__ps1_utf8time "$(date +"%I")" "$(date +"%M")")\D{}â”œ$(printf %$((COLUMNS-54))s | sed "s/ /â”€/g")â•¯")'
         }
         else {
              PS0='$(lolcat-c '${PS1_lc_opts[*]}' <<< "â•¾â•¨â”€â”€â”€â”€â”¤Program running   \d \D{}â”œ$(printf %$((COLUMNS-49))s | sed "s/ /â”€/g")â•®")'
           PS1_L0='$(lolcat-c '${PS1_lc_opts[*]}' <<< "â•¾â•¥â”€â”€â”€â”€â”¤Program finished  \d \D{}â”œ$(printf %$((COLUMNS-49))s | sed "s/ /â”€/g")â•¯")'
         }; fi
         PS1='$(lolcat-c '${PS1_lc_opts[*]}' <<< "'${PS1_L0}${PS1_L1}${PS1_L2}${PS1_L3}'" | sed -z "s/\(.*\)\\n/\1/" | __ps1_color_wrap_non_printing)'
         PS2="$(lolcat-c "${PS1_lc_opts[@]}" <<< " â• â•â•$(__ps1_utf8 â•¾ â”ˆ) " | sed -z "s/\(.*\)\\n/\1/" | __ps1_color_wrap_non_printing)"
    ;;
    *) if [[ "${TERM}" == xterm* ]]
       then {
            PS0="â•¾â•¨â”€â”€â”€â”€â”¤Program running  $(__ps1_utf8 "ğŸ—“ï¸ ") \d  $(__ps1_utf8time "$(date +"%I")" "$(date +"%M")") \D{}â”œ$(printf %$((COLUMNS-62))s | sed "s/ /â”€/g")â•®\n"
         PS1_L0="â•¾â•¥â”€â”€â”€â”€â”¤Program finished $(__ps1_utf8 "ğŸ—“ï¸ ") \d  $(__ps1_utf8time "$(date +"%I")" "$(date +"%M")") \D{}â”œ$(printf %$((COLUMNS-62))s | sed "s/ /â”€/g")â•¯\n"
       }
       else {
         # shellcheck disable=SC2034
            PS0="â•¾â•¨â”€â”€â”€â”€â”¤Program running   \d \D{}â”œ$(printf %$((COLUMNS-49))s | sed "s/ /â”€/g")â•®"
         PS1_L0="â•¾â•¥â”€â”€â”€â”€â”¤Program finished  \d \D{}â”œ$(printf %$((COLUMNS-49))s | sed "s/ /â”€/g")â•¯"
       }; fi
       PS1="${PS1_L0}${PS1_L1}${PS1_L2}${PS1_L3}"
       PS2=" â• â•â•$(__ps1_utf8 â•¾ â”ˆ) "
    ;;
  esac
  if [[ "${TERM}" ==  xterm* || "${TERM}" == rxvt* ]]
  then {
    PS1="\[\e]0;$(__ps1_getVirtualenv) \u@\h($(__ps1_tty))($(jobs -r | wc -l)R/$(jobs -s | wc -l)S):\w (idle)\a\]${PS1}"
  }; fi
}
PROMPT_COMMAND="__prompt_command${PROMPT_COMMAND:+; ${PROMPT_COMMAND}}"

# vim:et:sts=2:sw=2:ts=2
